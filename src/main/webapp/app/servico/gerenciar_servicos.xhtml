<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="primefaces">

    <h:head>
        <title>Gerenciar Serviços</title>
        <h:outputStylesheet library="css" name="admin.css"/>
        <h:outputStylesheet library="css" name="servicos.css"/>
        
        <!-- Scripts para validação de serviços -->
        <h:outputScript name="js/floating-messages.js" />
        <h:outputScript name="js/form-success-monitor.js" />
        <h:outputScript name="js/servico/servico-validation.js" />
        <h:outputScript name="js/servico/servico-main.js" />
        
        <script>
            //<![CDATA[
            function monitorarMensagens(data) {
                if (data.status === 'success' && window.FormSuccessMonitor) {
                    setTimeout(function() {
                        window.FormSuccessMonitor.monitor();
                    }, 100);
                }
            }
            
            // Exibe mensagem flutuante ao carregar a página (vinda de redirect)
            document.addEventListener('DOMContentLoaded', function() {
                if (window.FormSuccessMonitor) {
                    window.FormSuccessMonitor.monitor();
                }
            });
            //]]>
        </script>
    </h:head>

    <h:body>
        <div class="servicos-container">
            <!-- Header -->
            <div class="servicos-header">
                <h1>Gerenciamento de Serviços</h1>
                <div class="servicos-actions">
                    <h:form>
                        <h:commandButton value="Novo Serviço" 
                                         action="#{servicoController.navigateToAdd}"
                                         styleClass="btn btn-primary" />
                        <h:commandButton value="Voltar ao Painel" 
                                         action="/app/admin.xhtml?faces-redirect=true"
                                         styleClass="btn btn-secondary"
                                         immediate="true" />
                    </h:form>
                </div>
            </div>

            <h:form id="servicosForm">
                <!-- Campos hidden para capturar mensagens (incluindo do Flash Scope) -->
                <h:inputHidden id="hiddenLastMessage" value="#{servicoController.lastMessage}" />
                <h:inputHidden id="hiddenMessageType" value="#{servicoController.messageType}" />
                
                <!-- Filtros de Busca -->
                <div class="servicos-filters">
                    <h3>Buscar Serviços</h3>
                    <div class="filter-row">
                        <p:inputText value="#{servicoController.searchNome}" 
                                     placeholder="Buscar por nome..."
                                     styleClass="form-control search-input" />
                        <h:commandButton value="Buscar"
                                         action="#{servicoController.searchByNome}"
                                         styleClass="btn btn-info">
                            <f:ajax execute="@form" render=":servicosForm:lista-servicos :servicosForm:hiddenLastMessage :servicosForm:hiddenMessageType" />
                        </h:commandButton>

                        <h:commandButton value="Limpar"
                                         action="#{servicoController.clearFilters}"
                                         styleClass="btn btn-secondary">
                            <f:ajax execute="@form" render=":servicosForm:lista-servicos :servicosForm:hiddenLastMessage :servicosForm:hiddenMessageType" />
                        </h:commandButton>

                    </div>
                </div>

                <!-- Lista de Serviços -->
                <h:panelGroup id="lista-servicos">
                    <ui:include src="fragments/lista_servicos.xhtml" />
                </h:panelGroup>

            </h:form>
            
            <!-- Container dedicado para mensagens flutuantes -->
            <div id="floating-message" class="floating-message" style="display: none;"></div>
        </div>
    </h:body>
</html>