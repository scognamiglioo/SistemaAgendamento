<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core">

    <div class="servicos-list">
        <h3>Lista de Servi√ßos (#{servicoController.servicosCount} encontrados)</h3>
        
        <!-- Estado sem servi√ßos -->
        <h:panelGroup rendered="#{empty servicoController.servicos}">
            <div class="no-results">
                <p>Nenhum servi√ßo encontrado.</p>
                <h:form>
                    <h:commandButton value="Cadastrar Primeiro Servi√ßo" 
                                   action="#{servicoController.navigateToAdd}"
                                   styleClass="btn btn-primary" />
                </h:form>
            </div>
        </h:panelGroup>
        
        <!-- Lista de servi√ßos com funcionalidade JavaScript otimizada -->
        <h:panelGroup rendered="#{not empty servicoController.servicos}">
            <script type="text/javascript">
                // Fun√ß√£o otimizada para toggle de funcion√°rios (mantida para compatibilidade)
                function toggleFuncionarios(servicoId) {
                    // Delega para o sistema modularizado
                    if (window.toggleFuncionariosServico) {
                        window.toggleFuncionariosServico(servicoId);
                        return;
                    }
                    
                    // Fallback caso os m√≥dulos n√£o estejam carregados
                    const contentDiv = document.getElementById('funcionarios-content-' + servicoId);
                    const button = document.getElementById('btn-funcionarios-' + servicoId);
                    
                    if (!contentDiv) {
                        console.error('Elemento n√£o encontrado: funcionarios-content-' + servicoId);
                        return;
                    }
                    
                    const isHidden = contentDiv.style.display === 'none' || contentDiv.style.display === '';
                    
                    if (isHidden) {
                        // Expandir
                        contentDiv.style.display = 'block';
                        contentDiv.style.padding = '15px 20px';
                        if (button) button.textContent = 'üë• Esconder Funcion√°rios';
                    } else {
                        // Esconder
                        contentDiv.style.display = 'none';
                        contentDiv.style.padding = '0';
                        if (button) button.textContent = 'üë• Ver Funcion√°rios';
                    }
                }
            </script>
            
            <!-- Formul√°rio √∫nico otimizado -->
            <h:form id="form-servicos">
                <div class="servicos-cards">
                    <ui:repeat value="#{servicoController.servicos}" var="servico">
                        <div class="servico-card">
                            <!-- Cabe√ßalho do Servi√ßo -->
                            <div class="servico-header">
                                <div class="servico-info">
                                    <h4>#{servico.nome}</h4>
                                    <div class="servico-details">
                                        <span class="servico-id">ID: #{servico.id}</span>
                                        <span class="servico-valor">
                                            <h:outputText value="#{servico.valor}">
                                                <f:convertNumber type="currency" currencySymbol="R$ " />
                                            </h:outputText>
                                        </span>
                                    </div>
                                </div>
                                <div class="servico-actions">
                                    <h:commandButton value="Editar" 
                                                   action="#{servicoController.navigateToEdit(servico.id)}"
                                                   styleClass="btn btn-sm btn-warning"
                                                   title="Editar servi√ßo"
                                                   immediate="true" />
                                    
                                    <h:commandButton value="Excluir" 
                                                   action="#{servicoController.delete(servico.id)}"
                                                   styleClass="btn btn-sm btn-danger"
                                                   title="Excluir servi√ßo"
                                                   onclick="return verificarExclusaoAntesServico(this);"
                                                   immediate="true">
                                        <f:passThroughAttribute name="data-funcionarios" value="#{servicoController.getFuncionariosCountByServico(servico.id)}" />
                                        <f:passThroughAttribute name="data-nome" value="#{servico.nome}" />
                                        <f:passThroughAttribute name="data-id" value="#{servico.id}" />
                                        <f:ajax render="@form" onevent="handleDeleteCompleteServico" />
                                    </h:commandButton>
                                </div>
                            </div>
                            
                            <!-- Toggle para funcion√°rios -->
                            <div class="funcionarios-toggle">
                                <button 
                                    id="btn-funcionarios-#{servico.id}"
                                    type="button"
                                    class="btn-funcionarios-arrow"
                                    onclick="toggleFuncionarios('#{servico.id}');">
                                    üë• Ver Funcion√°rios
                                </button>
                            </div>
                                
                            <!-- Conte√∫do dos funcion√°rios (sempre renderizado, controle via JavaScript) -->
                            <div id="funcionarios-content-#{servico.id}" style="display: none;">
                                
                                <!-- Lista de funcion√°rios quando existem -->
                                <h:panelGroup rendered="#{not empty servicoController.funcionariosPorServicoMap[servico.id]}">
                                    <div style="background: #eeffee; padding: 10px; margin-bottom: 10px; font-size: 12px;">
                                        ‚úÖ #{servicoController.getFuncionariosCountByServico(servico.id)} funcion√°rio(s) encontrado(s)
                                    </div>
                                    <ul class="funcionarios-simple-list">
                                        <ui:repeat value="#{servicoController.funcionariosPorServicoMap[servico.id]}" var="funcionario">
                                            <li>
                                                <strong>#{funcionario.nome}</strong><br/>
                                                <small>Email: #{funcionario.email} | CPF: #{funcionario.cpf}</small>
                                            </li>
                                        </ui:repeat>
                                    </ul>
                                </h:panelGroup>
                                
                                <!-- Mensagem quando n√£o h√° funcion√°rios -->
                                <h:panelGroup rendered="#{empty servicoController.funcionariosPorServicoMap[servico.id]}">
                                    <div class="no-funcionarios">
                                        <p>‚ùå Nenhum funcion√°rio associado a este servi√ßo</p>
                                    </div>
                                </h:panelGroup>
                                
                            </div>
                        </div>
                    </ui:repeat>
                </div>
            </h:form>
        </h:panelGroup>
    </div>

</ui:composition>