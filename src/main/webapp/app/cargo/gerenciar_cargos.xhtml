<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions">

    <h:head>
        <title>Gerenciar Cargos</title>
        <h:outputStylesheet library="css" name="admin.css"/>
        <h:outputStylesheet library="css" name="servicos.css"/>
    </h:head>
    
    <h:body>
        <f:metadata>
            <f:viewAction action="#{cargoController.loadCargos}" />
        </f:metadata>

        <div class="servicos-container">
            <!-- Header -->
            <div class="servicos-header">
                <h1>Gerenciamento de Cargos</h1>
                <div class="servicos-actions">
                    <h:form>
                        <h:commandButton value="Novo Cargo" 
                                       action="#{cargoController.navigateToAdd}"
                                       styleClass="btn btn-primary" />
                        <h:commandButton value="Voltar ao Painel" 
                                       action="/app/admin.xhtml?faces-redirect=true"
                                       styleClass="btn btn-secondary"
                                       immediate="true" />
                    </h:form>
                </div>
            </div>

            <h:form id="cargoForm">
                <!-- Mensagem flutuante personalizada -->
                <div id="floating-message" class="floating-message" style="display: none;"></div>
                
                <!-- Campos hidden para capturar mensagens com IDs corretos -->
                <h:inputHidden id="hiddenLastMessage" value="#{cargoController.lastMessage}" />
                <h:inputHidden id="hiddenMessageType" value="#{cargoController.messageType}" />
                           
                <!-- Filtros de Busca -->
                <div class="servicos-filters">
                    <h3>Buscar Cargos</h3>
                    <div class="filter-row">
                        <h:inputText value="#{cargoController.searchNome}" 
                                   placeholder="Buscar por nome..."
                                   styleClass="form-control search-input" />
                        <h:commandButton value="Buscar" 
                                       action="#{cargoController.searchByNome}"
                                       styleClass="btn btn-info" 
                                       update="lista-cargos"/>
                        <h:commandButton value="Limpar" 
                                       action="#{cargoController.clearFilters}"
                                       styleClass="btn btn-secondary" 
                                       update="lista-cargos"/>
                    </div>
                </div>

                <!-- Lista de Cargos -->
                <h:panelGroup id="lista-cargos">
                    <h:panelGroup rendered="#{empty cargoController.cargos}">
                        <div class="servicos-empty">
                            <p>Nenhum cargo encontrado.</p>
                        </div>
                    </h:panelGroup>

                    <h:panelGroup rendered="#{not empty cargoController.cargos}">
                        <div class="servicos-stats">
                            <span class="stats-text">Total de cargos: #{cargoController.cargosCount}</span>
                        </div>
                        
                        <!-- Script externo para evitar problemas de parse XML -->
                        <!-- Scripts modularizados para cargo -->
                        <h:outputScript name="js/floating-messages.js" />
                        <h:outputScript name="js/form-success-monitor.js" />
                        <h:outputScript name="js/cargo/cargo-validation.js" />
                        <h:outputScript name="js/cargo/cargo-main.js" />
                        
                        <!-- CSS para cargo -->
                        <h:outputStylesheet name="css/cargos.css" />
                        
                        <div class="servicos-cards">
                            <ui:repeat value="#{cargoController.cargos}" var="cargo">
                                <div class="servico-card">
                                    <!-- Cabe√ßalho do Cargo -->
                                    <div class="servico-header">
                                        <div class="servico-info">
                                            <h4>#{cargo.nome}</h4>
                                            <div class="servico-details">
                                                <span class="servico-id">ID: #{cargo.id}</span>
                                                <span class="servico-meta">
                                                    #{cargoController.getFuncionariosCount(cargo.id)} funcion√°rio(s)
                                                </span>
                                            </div>
                                        </div>
                                        <div class="servico-actions">
                                            <h:commandButton value="Editar" 
                                                           action="#{cargoController.navigateToEdit(cargo.id)}"
                                                           styleClass="btn btn-sm btn-warning"
                                                           title="Editar cargo"
                                                           immediate="true" />
                                            
                                            <h:commandButton value="Excluir" 
                                                           styleClass="btn btn-sm btn-danger btn-excluir"
                                                           title="Excluir cargo"
                                                           onclick="return verificarExclusaoAntes(this);"
                                                           action="#{cargoController.delete(cargo.id)}"
                                                           immediate="true"
                                                           oncomplete="handleDeleteComplete(event)">
                                                <f:passThroughAttribute name="data-funcionarios" value="#{cargoController.getFuncionariosCount(cargo.id)}" />
                                                <f:passThroughAttribute name="data-nome" value="#{cargo.nome}" />
                                                <f:passThroughAttribute name="data-id" value="#{cargo.id}" />
                                                <f:ajax render="@form" execute="@this" />
                                            </h:commandButton>
                                        </div>
                                    </div>
                                    
                                    <!-- Toggle para funcion√°rios -->
                                    <div class="funcionarios-toggle">
                                        <button 
                                            id="btn-funcionarios-cargo-#{cargo.id}"
                                            type="button"
                                            class="btn-funcionarios-arrow"
                                            onclick="toggleFuncionariosCargo('#{cargo.id}');">
                                            üë• Ver Funcion√°rios
                                        </button>
                                    </div>
                                        
                                    <!-- Conte√∫do dos funcion√°rios (sempre renderizado, controle via JavaScript) -->
                                    <div id="funcionarios-content-cargo-#{cargo.id}" style="display: none;">
                                        
                                        <!-- Lista de funcion√°rios quando existem -->
                                        <h:panelGroup rendered="#{not empty cargoController.funcionariosPorCargoMap[cargo.id]}">
                                            <div style="background: #eeffee; padding: 10px; margin-bottom: 10px; font-size: 12px;">
                                                ‚úÖ #{cargoController.getFuncionariosCount(cargo.id)} funcion√°rio(s) neste cargo
                                            </div>
                                            <ul class="funcionarios-simple-list">
                                                <ui:repeat value="#{cargoController.funcionariosPorCargoMap[cargo.id]}" var="funcionario">
                                                    <li>
                                                        <strong>#{funcionario.nome}</strong><br/>
                                                        <small>Email: #{funcionario.email} | CPF: #{funcionario.cpf}</small>
                                                    </li>
                                                </ui:repeat>
                                            </ul>
                                        </h:panelGroup>
                                        
                                        <!-- Mensagem quando n√£o h√° funcion√°rios -->
                                        <h:panelGroup rendered="#{empty cargoController.funcionariosPorCargoMap[cargo.id]}">
                                            <div class="no-funcionarios">
                                                <p>‚ùå Nenhum funcion√°rio associado a este cargo</p>
                                            </div>
                                        </h:panelGroup>
                                        
                                    </div>
                                </div>
                            </ui:repeat>
                        </div>
                    </h:panelGroup>
                </h:panelGroup>
            </h:form>
        </div>
    </h:body>
</html>